{
  "nodes": [
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-photo-001",
              "leftValue": "={{ $json.message.photo }}",
              "rightValue": "",
              "operator": {
                "type": "array",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -7520,
        -416
      ],
      "id": "420ae37e-d69d-4a44-9e58-075f8b1f7a20",
      "name": "Check if Image"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.photo[$json.message.photo.length - 1].file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -7152,
        -432
      ],
      "id": "6fe6e96c-c28a-4a36-a513-3f68fc7542b7",
      "name": "Get Image File",
      "webhookId": "get-image-webhook-001",
      "credentials": {
        "telegramApi": {
          "id": "sl2XyaTKmEdfH4KK",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "resource": "image",
        "operation": "analyze",
        "modelId": {
          "__rl": true,
          "value": "chatgpt-4o-latest",
          "mode": "list",
          "cachedResultName": "CHATGPT-4O-LATEST"
        },
        "inputType": "base64",
        "binaryPropertyName": "={{ Object.keys($binary)[0] || 'data' }}",
        "options": {
          "detail": "high"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -6768,
        -432
      ],
      "id": "0d0b421a-1845-4574-bdcd-5f204aed01b6",
      "name": "Analyze Receipt with Vision",
      "credentials": {
        "openAiApi": {
          "id": "n7FcR0fOh99ziM2b",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "extract-expense-001",
              "name": "text",
              "value": "={{ (() => { try { let rawResponse = $json.response || $json.content || $json.text || $json.message || ''; let analysis = null; let amount = 0; let category = 'other'; let merchant = 'Unknown'; let items = ''; if (typeof rawResponse === 'object') { analysis = rawResponse; } else if (typeof rawResponse === 'string') { try { analysis = JSON.parse(rawResponse); } catch (parseErr) { const text = rawResponse; const totalMatch = text.match(/\\*\\*(?:Sub\\s*)?Total:\\*\\*.*?\\$([0-9,]+(?:\\.[0-9]{2})?)|(?:Sub\\s*)?Total:?\\s*\\$([0-9,]+(?:\\.[0-9]{2})?)|(?:SUB\\s*)?TOTAL.*?\\$([0-9,]+(?:\\.[0-9]{2})?)/i); if (totalMatch) { const matched = totalMatch[1] || totalMatch[2] || totalMatch[3]; amount = parseFloat(matched.replace(/,/g, '')) || 0; } const merchantMatch = text.match(/(?:from|at|receipt from)\\s+[\"']?([A-Za-z0-9\\s&]+)[\"']?/i) || text.match(/\\*\\*Store Name:\\*\\*\\s*([A-Z][A-Za-z0-9\\s&]+)/i) || text.match(/^([A-Z][A-Za-z0-9\\s&]+)(?:located|at|\\n)/m); if (merchantMatch) { merchant = merchantMatch[1].trim(); } const categoryKeywords = { 'groceries': /grocery|groceries|supermarket|food/i, 'gas': /gas|fuel|petrol/i, 'dining': /restaurant|dining|cafe|coffee/i, 'entertainment': /entertainment|movie|game/i, 'utilities': /utilities|electric|water/i }; for (const [cat, regex] of Object.entries(categoryKeywords)) { if (regex.test(text)) { category = cat; break; } } } } if (analysis && typeof analysis === 'object') { amount = parseFloat(analysis.amount) || amount; category = analysis.category || category; merchant = analysis.merchant || merchant; items = Array.isArray(analysis.items) ? analysis.items.join(', ') : (analysis.items || ''); } if (amount > 0) { return `Receipt processed: $${amount.toFixed(2)} at ${merchant} for ${category}${items ? ' (' + items + ')' : ''}`; } return 'Image received but no expense found'; } catch (e) { return 'Receipt image processed - error: ' + e.message; } })() }}",
              "type": "string"
            },
            {
              "id": "extract-expense-002",
              "name": "expense_data",
              "value": "={{ (() => { try { let rawResponse = $json.response || $json.content || $json.text || $json.message || ''; let analysis = null; let amount = 0; let category = 'other'; let merchant = 'Unknown'; let date = $now.toISO(); let items = []; let payment_method = 'unknown'; let notes = ''; if (typeof rawResponse === 'object') { analysis = rawResponse; } else if (typeof rawResponse === 'string') { try { analysis = JSON.parse(rawResponse); } catch (parseErr) { const text = rawResponse; const totalMatch = text.match(/\\*\\*(?:Sub\\s*)?Total:\\*\\*.*?\\$([0-9,]+(?:\\.[0-9]{2})?)|(?:Sub\\s*)?Total:?\\s*\\$([0-9,]+(?:\\.[0-9]{2})?)|(?:SUB\\s*)?TOTAL.*?\\$([0-9,]+(?:\\.[0-9]{2})?)/i); if (totalMatch) { const matched = totalMatch[1] || totalMatch[2] || totalMatch[3]; amount = parseFloat(matched.replace(/,/g, '')) || 0; } const merchantMatch = text.match(/(?:from|at|receipt from)\\s+[\"']?([A-Za-z0-9\\s&]+)[\"']?/i) || text.match(/\\*\\*Store Name:\\*\\*\\s*([A-Z][A-Za-z0-9\\s&]+)/i) || text.match(/^([A-Z][A-Za-z0-9\\s&]+)(?:located|at|\\n)/m); if (merchantMatch) { merchant = merchantMatch[1].trim(); } const categoryKeywords = { 'groceries': /grocery|groceries|supermarket|food/i, 'gas': /gas|fuel|petrol/i, 'dining': /restaurant|dining|cafe|coffee/i, 'entertainment': /entertainment|movie|game/i, 'utilities': /utilities|electric|water/i }; for (const [cat, regex] of Object.entries(categoryKeywords)) { if (regex.test(text)) { category = cat; break; } } notes = 'Parsed from text description'; } } if (analysis && typeof analysis === 'object') { amount = parseFloat(analysis.amount) || amount; category = analysis.category || category; merchant = analysis.merchant || merchant; date = analysis.date || date; items = analysis.items || items; payment_method = analysis.payment_method || payment_method; notes = analysis.notes || notes; } return { amount: amount, category: category, merchant: merchant, date: date, items: items, payment_method: payment_method, notes: notes }; } catch (e) { return { amount: 0, category: 'other', merchant: 'Unknown', date: $now.toISO(), items: [], payment_method: 'unknown', notes: 'Failed to parse receipt: ' + e.message }; } })() }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6368,
        -432
      ],
      "id": "033819d8-39cc-45f8-ae93-70c62a3b34d5",
      "name": "Format Expense Data"
    },
    {
      "parameters": {
        "updates": [
          "message"
        ],
        "additionalFields": {
          "download": false
        }
      },
      "id": "e98510d6-aacd-438e-bb32-2e4574c25538",
      "name": "Telegram Message Trigger1",
      "type": "n8n-nodes-base.telegramTrigger",
      "typeVersion": 1.2,
      "position": [
        -8000,
        -416
      ],
      "webhookId": "61396260-c024-467a-a04e-d71e2ef4fc83",
      "credentials": {
        "telegramApi": {
          "id": "sl2XyaTKmEdfH4KK",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "2b538077-d3d3-4713-b973-68748313ff97",
              "leftValue": "={{ $json.message.voice }}",
              "rightValue": "",
              "operator": {
                "type": "object",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -7648,
        -688
      ],
      "id": "a2295165-4a03-4a12-b55e-ffbfad2f69be",
      "name": "Check if Audio file1"
    },
    {
      "parameters": {
        "resource": "file",
        "fileId": "={{ $json.message.voice.file_id }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -7232,
        -720
      ],
      "id": "c9fc072e-3942-4d5a-9e8a-7dd7015e4c4e",
      "name": "Get a file1",
      "webhookId": "a50f0104-6e43-4a08-90f5-3e1dc050e450",
      "credentials": {
        "telegramApi": {
          "id": "sl2XyaTKmEdfH4KK",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-text-001",
              "leftValue": "={{ $json.message.text }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "notEmpty",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -7552,
        -112
      ],
      "id": "22c30736-546e-4dd6-bd73-fdfc4cc7afd8",
      "name": "Check if Text"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "eb912219-2436-4f04-8ffc-c1c20eb07344",
              "name": "text",
              "value": "={{ $json.message.text }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6736,
        -128
      ],
      "id": "7ae5af4d-1071-4bf3-9e1a-be8f3872832f",
      "name": "Set field1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "b78b673d-95a4-4d7c-b6a8-91e25c1d368d",
              "name": "user_id",
              "value": "={{ $node[\"Telegram Message Trigger1\"].json.message?.from?.id }}",
              "type": "string"
            },
            {
              "id": "7bb91beb-c6de-414e-ad16-3a029b337bcd",
              "name": "chat_id",
              "value": "={{ $node[\"Telegram Message Trigger1\"].json.message?.chat?.id }}",
              "type": "string"
            },
            {
              "id": "d3ba7439-af55-4838-b22d-bfb71a07472e",
              "name": "user_text",
              "value": "={{ $json.text || $json.transcription || $node[\"Telegram Message Trigger1\"].json.message?.text || '' }}",
              "type": "string"
            },
            {
              "id": "d4a517fd-6abe-4980-a2ae-9efc6101ff3b",
              "name": "ts",
              "value": "={{ $now }}",
              "type": "string"
            },
            {
              "id": "0a5d5b7b-0f36-4b79-9a9b-7d2a99b86a1f",
              "name": "sessionId",
              "value": "={{ $node[\"Telegram Message Trigger1\"].json.message?.chat?.id }}",
              "type": "string"
            },
            {
              "id": "expense-data-field-001",
              "name": "expense_data",
              "value": "={{ $json.expense_data || null }}",
              "type": "object"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6128,
        -432
      ],
      "id": "163d83a2-1d86-4b23-9977-d1aefbce2275",
      "name": "Edit Fields1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-first-time-user-001",
              "leftValue": "={{ $('Merge User Context1').item.json.user_profile.total_conversations }}",
              "rightValue": "1",
              "operator": {
                "type": "number",
                "operation": "lte",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -5312,
        -560
      ],
      "id": "9bedd461-e1e6-4bd4-9880-1f553fd102c9",
      "name": "Check if First Time User"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Message Trigger1').first().json.message.chat.id }}",
        "text": "ðŸŽ‰ Welcome to Budget Guardian! \n\nI'm your personal finance assistant, here to help you manage your money smarter. Here's what I can do for you:\n\nðŸ’° **Budget Tracking**\nâ€¢ Set monthly budgets for different categories (groceries, dining, gas, etc.)\nâ€¢ Track your spending and get alerts when you're close to limits\nâ€¢ View your remaining budget anytime\n\nðŸ“¸ **Receipt Scanning**\nâ€¢ Take photos of receipts and I'll automatically extract the expense details\nâ€¢ Categorize expenses and update your budget in real-time\n\nðŸŽ™ï¸ **Voice Messages**\nâ€¢ Send voice messages about your expenses - I'll transcribe and process them\n\nðŸ” **Price Comparison**\nâ€¢ Ask me to find the best deals on products you want to buy\nâ€¢ Get student discounts and coupon codes\nâ€¢ Compare prices across different stores\n\nðŸ“Š **Financial Analysis**\nâ€¢ Get insights into your spending patterns\nâ€¢ Receive personalized savings recommendations\nâ€¢ Track your financial goals\n\nðŸ“§ **Email Reports**\nâ€¢ Type \"/email your@email.com\" to receive a detailed email with all your budget statistics\nâ€¢ Get a comprehensive overview of your spending, budgets, and recent transactions\nâ€¢ Perfect for keeping your own records or sharing with family\n\n**Quick Start Tips:**\nâ€¢ Say \"set my grocery budget to $300\" to create your first budget\nâ€¢ Send a receipt photo to track an expense\nâ€¢ Ask \"what's my budget?\" to see your current status\nâ€¢ Try \"find cheap textbooks\" for price comparisons\nâ€¢ Use \"/email your@email.com\" to get a detailed budget report sent to you\n\nWhat would you like to do first? ðŸš€",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4960,
        -720
      ],
      "id": "a8851ccf-a33a-4827-8196-935f55d877f7",
      "name": "Send Welcome Message",
      "webhookId": "welcome-message-webhook-001",
      "credentials": {
        "telegramApi": {
          "id": "sl2XyaTKmEdfH4KK",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Message Trigger1').first().json.message.chat.id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -4880,
        -160
      ],
      "id": "7cc5294a-fb7b-4dfd-84a0-30cfe334c864",
      "name": "Simple Memory (Planner)1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Planner for Budget Guardian\n\nAnalyze the user's message and return ONLY a JSON object with these exact fields:\n- runAnalyst (boolean): true for budget/spending/savings analysis, false otherwise\n- runPrice (boolean): true for price/deal/discount searches, false otherwise  \n- price_queries (array): 1-3 search queries if runPrice=true, empty array otherwise\n- questions_for_user (array): up to 2 clarifying questions if needed, empty array otherwise\n\nRules:\n- Exactly ONE of runAnalyst or runPrice must be true (not both)\n- Default to runAnalyst=true if unclear\n- DO NOT use any tools or provide commentary\n- Respond ONLY with the structured data\n\nUser text: {{ $json.user_text }}",
        "hasOutputParser": true,
        "options": {
          "systemMessage": "You are a JSON classifier. Respond ONLY with valid JSON matching the requested schema. Never use tools or function calls."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -4976,
        -384
      ],
      "id": "618f9e13-67a4-4e21-a739-b4bde5a3c0c8",
      "name": "AI Agent - Planner1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "dcc09466-5438-4cf2-91ce-4773837a6a31",
              "leftValue": "={{ $json.runAnalyst }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "isTrue",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6688,
        384
      ],
      "id": "29c5de76-e30e-4d85-aabc-056b038457d5",
      "name": "If runAnalyst?1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "dcc09466-5438-4cf2-91ce-4773837a6a31",
              "leftValue": "={{ $json.runPrice }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "isTrue",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -6656,
        784
      ],
      "id": "698f7022-dfe0-4af1-9548-1637248ba191",
      "name": "If runPrice?1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Message Trigger1').first().json.message.chat.id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -6320,
        480
      ],
      "id": "5661fa29-4581-407a-bb81-ec34b5357e04",
      "name": "Simple Memory (Analyst)1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Financial Analyst Agent\nAnalyze the user's spending text and any embedded transactions (JSON/CSV-like). When data is missing, infer cautiously and ask for what's needed.\nReturn ONLY the fields defined by the connected output parser: insights, top_actions, savings_estimate. Use short strings for arrays.\n\n**USER FINANCIAL PROFILE:**\n{{ $('Merge User Context1').item.json.user_context_summary || 'New user - no previous data.' }}\n\nInput:\n- user_text: {{ $json.user_text }}\n\nConsider the user's historical spending patterns and income when providing insights. If they mention new spending or income, factor it into your analysis.",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -6368,
        288
      ],
      "id": "df5d56d1-4c5e-4648-b760-77a4f7ae6676",
      "name": "AI Agent - Analyst1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "c2d611c7-9833-4cde-8a90-bfb6864a53b0",
              "name": "output",
              "value": "={{ (() => { const a = (typeof $json.analysis === 'object' && $json.analysis) ? $json.analysis : $json; const insights = Array.isArray(a.insights) ? a.insights.slice(0,3) : []; const actions = Array.isArray(a.top_actions) ? a.top_actions.slice(0,3) : []; const se = a.savings_estimate || {}; const weekly = typeof se.weekly === 'number' ? se.weekly : null; const monthly = typeof se.monthly === 'number' ? se.monthly : null; const lines = []; const getUserText = () => { const fromCurrent = $json.user_text; if (typeof fromCurrent === 'string' && fromCurrent.trim().length) return fromCurrent; const fromNormalize = $('Sub Agentic Task1').item.json.user_text; if (typeof fromNormalize === 'string' && fromNormalize.trim().length) return fromNormalize; const fromEdit = $('Edit Fields1').item.json.user_text; return typeof fromEdit === 'string' ? fromEdit : ''; }; if (actions.length || insights.length || weekly !== null || monthly !== null) { lines.push('Here's your quick budget check-in:'); if (actions.length) { lines.push('Top actions:'); actions.forEach((t,i)=>lines.push(`${i+1}. ${t}`)); } if (weekly !== null || monthly !== null) { const w = weekly !== null ? `$${weekly.toFixed(2)}/wk` : ''; const m = monthly !== null ? ` (~$${monthly.toFixed(2)}/mo)` : ''; lines.push(`Est. savings: ${w}${m}`.trim()); } if (insights.length) { lines.push('Notes: ' + insights.join(' | ')); } } else { const ut = getUserText().slice(0,120); if (ut) { lines.push('Got it: ' + ut + '.'); } lines.push('Tell me the goal: analyze your spending or find cheaper options?'); } lines.push('â˜‘ï¸ Want me to set limits or track a category this week?'); return lines.join('\\n'); })() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5984,
        304
      ],
      "id": "897aa3ab-0e4d-4400-88ba-6dcb09c2df87",
      "name": "Compose Message - Analyst1"
    },
    {
      "parameters": {
        "query": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query', ``, 'string') }}",
        "additionalParameters": {}
      },
      "type": "@brave/n8n-nodes-brave-search.braveSearchTool",
      "typeVersion": 1,
      "position": [
        -6208,
        1008
      ],
      "id": "6de0495d-4e2d-4a67-8b52-e0141b551822",
      "name": "Brave Search (Retrieval)1",
      "credentials": {
        "braveSearchApi": {
          "id": "vr0EyDuMtCwAFnz6",
          "name": "Brave Search account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Message Trigger1').first().json.message.chat.id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -6368,
        1024
      ],
      "id": "53bf674e-e9f7-4cca-bb84-f47b0ee94142",
      "name": "Simple Memory (Retrieval)1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"additionalProperties\": false,\n  \"properties\": {\n    \"price_results\": {\n      \"type\": \"array\",\n      \"items\": {\n        \"type\": \"object\",\n        \"additionalProperties\": false,\n        \"properties\": {\n          \"merchant\": { \"type\": \"string\" },\n          \"price\": { \"type\": \"string\" },\n          \"title\": { \"type\": \"string\" },\n          \"link\": { \"type\": \"string\" }\n        },\n        \"required\": []\n      },\n      \"minItems\": 0,\n      \"maxItems\": 5\n    }\n  },\n  \"required\": []\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -6048,
        1008
      ],
      "id": "e5c1bf12-5934-4da2-8133-1ed8c03944d0",
      "name": "Structured Output Parser (Retrieval)1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Data Retrieval Agent (price/deals)\nUse the Brave Search tool. If price_queries exist, start with those; otherwise derive queries. Look for student discounts, coupon codes, cheaper alternatives, bundles, and trustworthy merchants. Extract prices when possible.\nReturn ONLY price_results as per the connected parser with the 3â€“5 best results.\nInputs:\n- user_text: {{ $json.user_text }}\n- price_queries: {{ $json.price_queries || [] }}",
        "hasOutputParser": true,
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -6368,
        768
      ],
      "id": "3a5bf3ba-a46d-4481-b187-7c2390ea8652",
      "name": "AI Agent - Data Retrieval1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9a5f4fbe-b60f-4f5f-a90d-80c15b7eccdf",
              "name": "output",
              "value": "={{ (() => { const src = $json.price_results || $json.results || $json.offers || []; const items = Array.isArray(src) ? src.slice(0,3) : []; const lines = []; if (!items.length) { lines.push('I could not find prices yet. Can you specify the product or merchant?'); } else { lines.push('Best options I found:'); items.forEach(it => { const merchant = it.merchant || ''; const price = it.price || ''; const title = it.title || ''; const link = it.link || ''; const line = `â€¢ ${merchant} â€“ ${price} â€“ ${title}${link ? ' (' + link + ')' : ''}`; lines.push(line); }); } lines.push('Tip: Check student plans and cancel unused subscriptions to save more.'); lines.push('â˜‘ï¸ Want me to set a monthly cap or alerts for this category?'); return lines.join('\\n'); })() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6016,
        800
      ],
      "id": "3a1dcade-4c83-462d-8be7-dd7718c4ea9e",
      "name": "Compose Message - Price1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"additionalProperties\": false,\n  \"properties\": {\n    \"runAnalyst\": { \"type\": \"boolean\", \"description\": \"Exactly one of runAnalyst or runPrice must be true.\" },\n    \"runPrice\": { \"type\": \"boolean\", \"description\": \"Exactly one of runAnalyst or runPrice must be true.\" },\n    \"price_queries\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" },\n      \"minItems\": 0,\n      \"maxItems\": 3,\n      \"description\": \"If runPrice=true, include 1â€“3 concise queries; otherwise leave empty.\"\n    },\n    \"questions_for_user\": {\n      \"type\": \"array\",\n      \"items\": { \"type\": \"string\" },\n      \"minItems\": 0,\n      \"maxItems\": 2\n    }\n  },\n  \"required\": [\"runAnalyst\", \"runPrice\", \"price_queries\", \"questions_for_user\"]\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -4752,
        -160
      ],
      "id": "cec830a5-10f0-4a98-8e4e-002a524a6f85",
      "name": "Structured Output Parser1"
    },
    {
      "parameters": {
        "schemaType": "manual",
        "inputSchema": "{\n  \"type\": \"object\",\n  \"additionalProperties\": false,\n  \"properties\": {\n    \"insights\": { \"type\": \"array\", \"items\": { \"type\": \"string\" }, \"minItems\": 0, \"maxItems\": 5 },\n    \"top_actions\": { \"type\": \"array\", \"items\": { \"type\": \"string\" }, \"minItems\": 0, \"maxItems\": 5 },\n    \"savings_estimate\": {\n      \"type\": \"object\",\n      \"additionalProperties\": false,\n      \"properties\": {\n        \"weekly\": { \"type\": \"number\" },\n        \"monthly\": { \"type\": \"number\" }\n      }\n    }\n  },\n  \"required\": []\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.3,
      "position": [
        -6208,
        480
      ],
      "id": "7a66f03d-041c-440a-bb85-670e6f195f19",
      "name": "Structured Output Parser (Analyst)1"
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5856,
        -848
      ],
      "id": "3152f70d-58eb-4c9a-8a80-ca5e032bb931",
      "name": "Fetch User Profile1",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "4lrtFcWMFMluvyaj",
          "name": "Supabase account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "user-context-merge-001",
              "name": "user_id",
              "value": "={{ $('Edit Fields1').item.json.user_id }}",
              "type": "string"
            },
            {
              "id": "user-context-merge-002",
              "name": "chat_id",
              "value": "={{ $('Edit Fields1').item.json.chat_id }}",
              "type": "string"
            },
            {
              "id": "user-context-merge-003",
              "name": "user_text",
              "value": "={{ $('Edit Fields1').item.json.user_text }}",
              "type": "string"
            },
            {
              "id": "user-context-merge-004",
              "name": "sessionId",
              "value": "={{ $('Edit Fields1').item.json.sessionId }}",
              "type": "string"
            },
            {
              "id": "user-context-merge-005",
              "name": "user_profile",
              "value": "={{ (() => { const profile = $json; if (!profile || !profile.user_id) { return { monthly_income: null, monthly_spending: {}, categories: { groceries: 0, gas: 0, dining: 0, entertainment: 0, utilities: 0, other: 0 }, budget_limits: {}, spending_goals: [], last_updated: null, total_conversations: 0, total_budget: null, remaining_budget: null, ai_savings_total: 0, ai_savings_recommendations: [] }; } return { monthly_income: profile.monthly_income || null, monthly_spending: profile.monthly_spending || {}, categories: profile.categories || { groceries: 0, gas: 0, dining: 0, entertainment: 0, utilities: 0, other: 0 }, budget_limits: profile.budget_limits || {}, spending_goals: profile.spending_goals || [], last_updated: profile.last_updated || null, total_conversations: (profile.total_conversations || 0) + 1, notes: profile.notes || '', total_budget: profile.total_budget || null, remaining_budget: profile.remaining_budget || null, ai_savings_total: profile.ai_savings_total || 0, ai_savings_recommendations: profile.ai_savings_recommendations || [] }; })() }}",
              "type": "object"
            },
            {
              "id": "user-context-merge-006",
              "name": "user_context_summary",
              "value": "={{ (() => { const profile = $json; if (!profile || !profile.user_id) { return 'New user - no previous data.'; } const parts = []; if (profile.total_budget) { parts.push(`Total Budget: $${profile.total_budget}${profile.remaining_budget !== null ? ` (Remaining: $${profile.remaining_budget.toFixed(2)})` : ''}`); } if (profile.monthly_income) { parts.push(`Monthly income: $${profile.monthly_income}`); } if (profile.ai_savings_total && profile.ai_savings_total > 0) { parts.push(`AI has helped save: $${profile.ai_savings_total.toFixed(2)} total`); } const limits = profile.budget_limits || {}; if (Object.keys(limits).length) { const limitStrs = []; for (const [cat, amt] of Object.entries(limits)) { if (amt) limitStrs.push(`${cat}: $${amt}`); } if (limitStrs.length) { parts.push(`Category Budgets: ${limitStrs.join(', ')}`); } } const cats = profile.categories || {}; const spending = []; if (cats.groceries) spending.push(`Groceries: $${cats.groceries}`); if (cats.gas) spending.push(`Gas: $${cats.gas}`); if (cats.dining) spending.push(`Dining: $${cats.dining}`); if (cats.entertainment) spending.push(`Entertainment: $${cats.entertainment}`); if (cats.utilities) spending.push(`Utilities: $${cats.utilities}`); if (cats.other) spending.push(`Other: $${cats.other}`); if (spending.length) { parts.push(`Current Month Spending - ${spending.join(', ')}`); } if (profile.spending_goals && profile.spending_goals.length) { parts.push(`Goals: ${profile.spending_goals.join('; ')}`); } if (profile.notes) { const recentNotes = profile.notes.split('\\n').slice(-3).join('; '); parts.push(`Recent: ${recentNotes}`); } return parts.length ? parts.join(' | ') : 'User exists but no financial data yet.'; })() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5616,
        -592
      ],
      "id": "ecb77d2d-8472-4f16-8e27-a292f26e3f7c",
      "name": "Merge User Context1"
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Telegram Message Trigger1').first().json.message.chat.id }}",
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryBufferWindow",
      "typeVersion": 1.3,
      "position": [
        -4880,
        496
      ],
      "id": "384cc96e-b11e-4ddd-8914-28051107a26a",
      "name": "Simple Memory (Direct Response)1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "detect-budget-query-flag",
              "name": "is_budget_query",
              "value": "={{ (() => { const getText = () => { const current = $json.user_text; if (typeof current === 'string' && current.trim().length) return current; const fromEdit = $('Edit Fields1').item.json.user_text; return typeof fromEdit === 'string' ? fromEdit : ''; }; const textRaw = getText(); const text = textRaw.toLowerCase(); if (!text.includes('budget') && !text.includes('limit') && !text.includes('left in')) { return false; } const intentWords = ['what', 'how', 'show', 'tell', 'remind', 'check', 'do i have', 'whats', 'how much', 'how many']; const commandWords = ['set', 'update', 'change', 'adjust', 'increase', 'decrease', 'raise', 'lower', 'make', 'add']; const hasCommand = commandWords.some(w => text.includes(w + ' ')) || /set\\s+.*budget/.test(text); const hasQuestion = intentWords.some(w => text.includes(w)); const isQuestionMark = text.includes('?'); if ((hasQuestion || isQuestionMark) && !hasCommand) { return true; } if (!hasCommand && /what\\s+is\\s+my.*budget/.test(text)) { return true; } if (!hasCommand && /(remaining|left)\\s+(in|on)\\s+.*budget/.test(text)) { return true; } return false; })() }}",
              "type": "boolean"
            },
            {
              "id": "detect-budget-query-category",
              "name": "budget_category",
              "value": "={{ (() => { const getText = () => { const current = $json.user_text; if (typeof current === 'string' && current.trim().length) return current; const fromEdit = $('Edit Fields1').item.json.user_text; return typeof fromEdit === 'string' ? fromEdit : ''; }; const text = getText().toLowerCase(); const categories = [ { key: 'groceries', words: ['grocery', 'groceries', 'food'] }, { key: 'gas', words: ['gas', 'fuel', 'petrol'] }, { key: 'dining', words: ['dining', 'restaurant', 'eating out', 'takeout'] }, { key: 'entertainment', words: ['entertainment', 'fun', 'movies', 'streaming'] }, { key: 'utilities', words: ['utilities', 'bills', 'electricity', 'water', 'internet'] }, { key: 'other', words: ['other', 'misc', 'miscellaneous'] } ]; for (const cat of categories) { if (cat.words.some(w => text.includes(w))) { return cat.key; } } if (text.includes('overall') || text.includes('total') || text.includes('monthly budget') || text.includes('whole budget')) { return 'overall'; } if (text.includes('budget') && !text.includes('grocer') && !text.includes('gas') && !text.includes('dining') && !text.includes('entertainment') && !text.includes('utilit')) { return 'overall'; } return ''; })() }}",
              "type": "string"
            },
            {
              "id": "detect-email-command-flag",
              "name": "is_email_command",
              "value": "={{ (() => { const getText = () => { const current = $json.user_text; if (typeof current === 'string' && current.trim().length) return current; const fromEdit = $('Edit Fields1').item.json.user_text; return typeof fromEdit === 'string' ? fromEdit : ''; }; const text = getText().toLowerCase().trim(); return text === '/email' || text.startsWith('/email ') || text.includes('email me my data') || text.includes('send me my data'); })() }}",
              "type": "boolean"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4528,
        -112
      ],
      "id": "a5262376-27d1-4941-ac86-8ba752099712",
      "name": "Detect Budget Query1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "if-budget-query-condition-001",
              "leftValue": "={{ $json.is_budget_query }}",
              "rightValue": "",
              "operator": {
                "type": "boolean",
                "operation": "isTrue",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -4256,
        -224
      ],
      "id": "e8af6a46-3eb8-431c-89f9-29213c2d2b6d",
      "name": "If Budget Query?1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "compose-budget-output-001",
              "name": "output",
              "value": "={{ (() => { const cat = ($json.budget_category || '').toLowerCase(); const profile = $('Merge User Context1').item.json.user_profile || {}; const budgetsDb = profile.budget_limits || {}; const spendingDb = profile.categories || {}; const detected = $json.expense_data || {}; const budgets = { ...budgetsDb }; const spending = { ...spendingDb }; if (detected && typeof detected === 'object' && detected.category) { const category = detected.category; if (typeof detected.amount === 'number' && isFinite(detected.amount)) { spending[category] = (typeof spending[category] === 'number' ? spending[category] : 0) + detected.amount; if (budgets[category] === undefined && detected.category_budget) { budgets[category] = detected.category_budget; } } } const fmt = (value) => (typeof value === 'number' && isFinite(value)) ? value.toFixed(2) : '0.00'; const lines = []; const buildCategoryLine = (category) => { const budgetValue = budgets[category]; const spentValue = spending[category] || 0; if (typeof budgetValue === 'number' && isFinite(budgetValue)) { const remaining = Math.max(0, budgetValue - (typeof spentValue === 'number' ? spentValue : 0)); lines.push(`Your ${category} budget is $${fmt(budgetValue)} per month.`); lines.push(`You've spent $${fmt(spentValue)} so far, leaving $${fmt(remaining)} this month.`); if (remaining <= budgetValue * 0.1) { lines.push(\"âš ï¸ You're almost at your limit â€” consider pausing this category.\"); } else if (remaining <= budgetValue * 0.25) { lines.push(\"Heads-up: you're getting close to the limit.\"); } } else { lines.push(`You haven't set a ${category} budget yet. Want me to set one now?`); } }; if (cat && cat !== 'overall' && cat !== 'total') { buildCategoryLine(cat); } else { const keys = Object.keys(budgets).filter(k => typeof budgets[k] === 'number' && isFinite(budgets[k])); if (keys.length) { lines.push('Here are your current monthly category budgets:'); keys.sort().forEach(k => { const budgetValue = budgets[k]; const spentValue = spending[k] || 0; const remaining = Math.max(0, (typeof budgetValue === 'number' ? budgetValue : 0) - (typeof spentValue === 'number' ? spentValue : 0)); lines.push(`${k}: $${fmt(budgetValue)} planned | $${fmt(spentValue)} spent | $${fmt(remaining)} left`); }); } else { lines.push(\"You haven't set any category budgets yet. Say \\\"set my grocery budget to $300\\\" to get started.\"); } if (typeof profile.total_budget === 'number' && isFinite(profile.total_budget)) { const spentTotal = Object.values(spending).reduce((sum, v) => sum + (typeof v === 'number' && isFinite(v) ? v : 0), 0); const remainingTotal = typeof profile.remaining_budget === 'number' && isFinite(profile.remaining_budget) ? profile.remaining_budget : Math.max(0, profile.total_budget - spentTotal); lines.push(`Overall budget: $${fmt(profile.total_budget)} planned | $${fmt(remainingTotal)} remaining.`); } } lines.push('Need to adjust any limits or add a new category? Just let me know.'); return lines.join('\\n'); })() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3984,
        -400
      ],
      "id": "7b906234-8840-4edf-a351-659b51a0e83d",
      "name": "Compose Message - Budget1"
    },
    {
      "parameters": {
        "query": "={{ /*n8n-auto-generated-fromAI-override*/ $fromAI('Query', ``, 'string') }}",
        "additionalParameters": {}
      },
      "type": "@brave/n8n-nodes-brave-search.braveSearchTool",
      "typeVersion": 1,
      "position": [
        -4672,
        496
      ],
      "id": "c4fa1c4e-cf32-4549-ac61-c5facf684e23",
      "name": "Brave Search (Direct Response)1",
      "credentials": {
        "braveSearchApi": {
          "id": "vr0EyDuMtCwAFnz6",
          "name": "Brave Search account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Direct Response AI Assistant\n\nYou are a helpful AI assistant for Budget Guardian. Keep responses SHORT and TO-THE-POINT (3-5 sentences max). Answer the user's query directly using web search when needed.\n\n**RESPONSE STYLE:**\n- Be concise and direct - NO long explanations or tables\n- Use bullet points ONLY when listing 3-4 items max\n- Skip introductions and filler text\n- Get straight to the answer\n- One follow-up question max\n\n**USER FINANCIAL PROFILE:**\n{{ $('Merge User Context1').item.json.user_context_summary || 'New user - no previous data.' }}\n\n**DETAILED USER DATA:**\n{{ (() => { const profile = $('Merge User Context1').item.json.user_profile || {}; const budgets = profile.budget_limits || {}; const spending = profile.categories || {}; const income = profile.monthly_income; const totalBudget = profile.total_budget; const remaining = profile.remaining_budget; const aiSavings = profile.ai_savings_total || 0; let details = []; if (income) details.push(`Income: $${income}/month`); if (totalBudget) details.push(`Total Budget: $${totalBudget} (Remaining: $${remaining || 0})`); if (aiSavings > 0) details.push(`AI Savings: $${aiSavings.toFixed(2)} total saved through recommendations`); Object.keys(spending).forEach(cat => { const spent = spending[cat] || 0; const budget = budgets[cat]; if (spent > 0 || budget) { details.push(`${cat}: spent $${spent}${budget ? ` / budget $${budget}` : ''}`); } }); return details.length ? details.join(' | ') : 'No spending data yet'; })() }}\n\n**RECEIPT PROCESSING:**\n{{ (() => { const expenseData = $('Edit Fields1').item.json.expense_data; if (expenseData && expenseData.amount > 0) { const userProfile = $('Merge User Context1').item.json.user_profile; const category = expenseData.category || 'other'; const categoryBudgets = userProfile?.budget_limits || {}; const categoryBudget = categoryBudgets[category]; const categorySpending = (userProfile?.categories || {})[category] || 0; const newCategorySpending = categorySpending + expenseData.amount; let msg = `Receipt detected! $${expenseData.amount.toFixed(2)} spent at ${expenseData.merchant} (${expenseData.category})`; if (categoryBudget) { const remaining = Math.max(0, categoryBudget - newCategorySpending); msg += `. ${category} spending: $${newCategorySpending.toFixed(2)} / $${categoryBudget} (${remaining.toFixed(2)} left)`; if (remaining < categoryBudget * 0.1) { msg += ' âš ï¸ Category budget almost depleted!'; } else if (remaining < categoryBudget * 0.3) { msg += ' âš ï¸ Warning: approaching category limit!'; } } else { msg += `. No ${category} budget set - say \"set my ${category} budget to $X\" to track it.`; } return msg; } return ''; })() }}\n\n**CRITICAL: PERSONALIZATION & SAVINGS TRACKING**\n- ALWAYS analyze the user's ACTUAL spending data above\n- For savings questions: identify their HIGHEST spending categories and give specific advice\n- Use REAL dollar amounts from their profile\n- Compare their spending to their budgets\n- Point out categories where they're overspending\n- PROACTIVELY suggest savings when you see overspending (even if not asked)\n- When suggesting savings, mention specific dollar amounts (e.g., \"save $150/month\")\n- Remind users of their total AI savings when relevant\n- Example: \"You've spent $450 on dining (no budget set). Cut that to $300/month and save $150. So far, I've helped you save $${aiSavings} total!\"\n\nFor queries about budgets:\n- Give SHORT, direct answers (2-3 sentences)\n- List only the MOST relevant 3-4 categories\n- Provide specific dollar amounts when available\n- Example: \"You can set budgets for: groceries, dining, gas, entertainment. Just say 'set my grocery budget to $300'.\"\n\nFor queries about saving money or reducing spending:\n- ANALYZE their actual spending data from DETAILED USER DATA above\n- Identify the TOP 2-3 categories where they spend the most\n- Give SPECIFIC dollar amounts and savings targets based on THEIR data\n- Example: \"Based on your spending: You spent $450 on dining and $200 on entertainment. Try cutting dining to $300 (save $150) and entertainment to $100 (save $100). That's $250/month saved.\"\n- If they have no spending data, ask them to share recent expenses first\n\nFor queries about finding products, prices, or locations:\n- Use Brave Search to find current information\n- List 2-3 best options only\n- Include prices and store names\n- Keep it brief\n\nFor financial questions:\n- Reference their ACTUAL spending numbers from profile\n- Give concise, actionable advice based on THEIR data (2-3 sentences)\n- Use specific dollar amounts from their profile\n- Skip lengthy explanations\n\nFor receipt uploads:\n- Acknowledge receipt briefly\n- Show budget impact if available\n- One sentence max\n\nFor general queries:\n- Answer in 2-4 sentences\n- Be friendly but brief\n- Use search only when needed\n\nUser query: {{ $json.user_text || $('Edit Fields1').item.json.user_text }}",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 2.2,
      "position": [
        -4976,
        272
      ],
      "id": "9eb6aa0e-8052-421c-a5b4-6a768e1c3e23",
      "name": "AI Agent - Direct Response1"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "e5f6a7b8-c9d0-1234-ef01-345678901234",
              "name": "output",
              "value": "={{ (() => { const response = $json.output || $json.text || $json.response || ''; if (typeof response === 'string' && response.trim()) { return response; } return 'I found some information for you, but had trouble formatting it. Please try rephrasing your question.'; })() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -4384,
        288
      ],
      "id": "6e55044c-eb06-4897-8d68-e7dcbb95eb25",
      "name": "Compose Message - Direct1"
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Message Trigger1').first().json.message.chat.id }}",
        "text": "={{ $json.output }}",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -4112,
        96
      ],
      "id": "ae284f36-9b46-4830-9086-7fcce23cad9c",
      "name": "Reply in Telegram (Direct)1",
      "webhookId": "direct-response-webhook-id",
      "credentials": {
        "telegramApi": {
          "id": "sl2XyaTKmEdfH4KK",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "extract-profile-001",
              "name": "user_id",
              "value": "={{ $('Merge User Context1').item.json.user_id }}",
              "type": "string"
            },
            {
              "id": "extract-profile-002",
              "name": "monthly_income",
              "value": "={{ (() => { const getSourceText = () => { const userText = $('Edit Fields1').item.json.user_text; if (typeof userText === 'string' && userText.trim()) { return userText; } const directText = $json.user_text; if (typeof directText === 'string' && directText.trim()) { return directText; } const outputText = $json.output; if (typeof outputText === 'string' && outputText.trim()) { return outputText; } return ''; }; const text = getSourceText().toLowerCase(); const existing = $('Merge User Context1').item.json.user_profile?.monthly_income; const incomeMatch = text.match(/(?:income|earn|make|salary).*?\\$?([0-9,]+)/i); if (incomeMatch) { return parseFloat(incomeMatch[1].replace(/,/g, '')); } const perMonth = text.match(/\\$?([0-9,]+)\\s*(?:per month|monthly|a month)/i); if (perMonth) { return parseFloat(perMonth[1].replace(/,/g, '')); } return existing || null; })() }}",
              "type": "number"
            },
            {
              "id": "extract-profile-003",
              "name": "categories",
              "value": "={{ (() => { const getSourceText = () => { const userText = $('Edit Fields1').item.json.user_text; if (typeof userText === 'string' && userText.trim()) { return userText; } const directText = $json.user_text; if (typeof directText === 'string' && directText.trim()) { return directText; } const outputText = $json.output; if (typeof outputText === 'string' && outputText.trim()) { return outputText; } return ''; }; const text = getSourceText().toLowerCase(); const existing = $('Merge User Context1').item.json.user_profile?.categories || {}; const categories = { ...existing }; const expenseData = $('Edit Fields1').item.json.expense_data; if (expenseData && expenseData.amount > 0) { const cat = expenseData.category || 'other'; categories[cat] = (categories[cat] || 0) + expenseData.amount; } const patterns = [ { key: 'groceries', regex: /(?:groceries|food|supermarket).*?\\$?([0-9,]+)/i }, { key: 'gas', regex: /(?:gas|fuel|petrol).*?\\$?([0-9,]+)/i }, { key: 'dining', regex: /(?:dining|restaurant|eating out).*?\\$?([0-9,]+)/i }, { key: 'entertainment', regex: /(?:entertainment|movies|streaming).*?\\$?([0-9,]+)/i }, { key: 'utilities', regex: /(?:utilities|bills|electricity|water|internet).*?\\$?([0-9,]+)/i } ]; patterns.forEach(p => { const match = text.match(p.regex); if (match) { categories[p.key] = parseFloat(match[1].replace(/,/g, '')); } }); return categories; })() }}",
              "type": "object"
            },
            {
              "id": "extract-profile-004",
              "name": "budget_limits",
              "value": "={{ (() => { const getSourceText = () => { const userText = $('Edit Fields1').item.json.user_text; if (typeof userText === 'string' && userText.trim()) { return userText; } const directText = $json.user_text; if (typeof directText === 'string' && directText.trim()) { return directText; } const outputText = $json.output; if (typeof outputText === 'string' && outputText.trim()) { return outputText; } return ''; }; const text = getSourceText().toLowerCase(); const existing = $('Merge User Context1').item.json.user_profile?.budget_limits || {}; const limits = { ...existing }; const patterns = [ { key: 'groceries', regex: /(?:set|my)?\\s*(?:grocery|groceries|food)\\s*budget\\s*(?:to|is|at)?\\s*\\$?([0-9,]+)/i }, { key: 'gas', regex: /(?:set|my)?\\s*(?:gas|fuel)\\s*budget\\s*(?:to|is|at)?\\s*\\$?([0-9,]+)/i }, { key: 'dining', regex: /(?:set|my)?\\s*(?:dining|restaurant|eating out)\\s*budget\\s*(?:to|is|at)?\\s*\\$?([0-9,]+)/i }, { key: 'entertainment', regex: /(?:set|my)?\\s*(?:entertainment|fun|leisure)\\s*budget\\s*(?:to|is|at)?\\s*\\$?([0-9,]+)/i }, { key: 'utilities', regex: /(?:set|my)?\\s*(?:utilities|bills)\\s*budget\\s*(?:to|is|at)?\\s*\\$?([0-9,]+)/i } ]; patterns.forEach(p => { const match = text.match(p.regex); if (match) { limits[p.key] = parseFloat(match[1].replace(/,/g, '')); } }); return limits; })() }}",
              "type": "object"
            },
            {
              "id": "extract-profile-005",
              "name": "spending_goals",
              "value": "={{ $('Merge User Context1').item.json.user_profile?.spending_goals || [] }}",
              "type": "json"
            },
            {
              "id": "extract-profile-006",
              "name": "total_conversations",
              "value": "={{ ($('Merge User Context1').item.json.user_profile?.total_conversations || 0) + 1 }}",
              "type": "number"
            },
            {
              "id": "extract-profile-007",
              "name": "last_updated",
              "value": "={{ $now.toISO() }}",
              "type": "string"
            },
            {
              "id": "extract-profile-008",
              "name": "notes",
              "value": "={{ (() => { const existing = $('Merge User Context1').item.json.user_profile?.notes || ''; const expenseData = $('Edit Fields1').item.json.expense_data; if (expenseData && expenseData.amount > 0) { const date = new Date(); const dateStr = date.toISOString().split('T')[0]; const newNote = `[${dateStr}] Receipt: $${expenseData.amount} at ${expenseData.merchant} (${expenseData.category})`; return existing ? existing + '\\n' + newNote : newNote; } return existing; })() }}",
              "type": "string"
            },
            {
              "id": "extract-profile-009",
              "name": "total_budget",
              "value": "={{ (() => { const getSourceText = () => { const userText = $('Edit Fields1').item.json.user_text; if (typeof userText === 'string' && userText.trim()) { return userText; } const directText = $json.user_text; if (typeof directText === 'string' && directText.trim()) { return directText; } const outputText = $json.output; if (typeof outputText === 'string' && outputText.trim()) { return outputText; } return ''; }; const text = getSourceText().toLowerCase(); const existing = $('Merge User Context1').item.json.user_profile?.total_budget; if (text.includes('dining') || text.includes('groceries') || text.includes('gas') || text.includes('entertainment') || text.includes('utilities') || text.includes('reduce') || text.includes('cut') || text.includes('lower') || text.includes('decrease')) { return existing || null; } const budgetMatch = text.match(/(?:set|my)?\\s*(?:overall|total|monthly)?\\s*budget\\s*(?:to|is|at)?\\s*\\$?([0-9,]+)/i); if (budgetMatch) { return parseFloat(budgetMatch[1].replace(/,/g, '')); } return existing || null; })() }}",
              "type": "number"
            },
            {
              "id": "extract-profile-010",
              "name": "remaining_budget",
              "value": "={{ (() => { const getSourceText = () => { const userText = $('Edit Fields1').item.json.user_text; if (typeof userText === 'string' && userText.trim()) { return userText; } const directText = $json.user_text; if (typeof directText === 'string' && directText.trim()) { return directText; } const outputText = $json.output; if (typeof outputText === 'string' && outputText.trim()) { return outputText; } return ''; }; const text = getSourceText().toLowerCase(); const existingBudget = $('Merge User Context1').item.json.user_profile?.total_budget; const existingRemaining = $('Merge User Context1').item.json.user_profile?.remaining_budget; const expenseData = $('Edit Fields1').item.json.expense_data; if (text.includes('dining') || text.includes('groceries') || text.includes('gas') || text.includes('entertainment') || text.includes('utilities')) { if (expenseData && expenseData.amount > 0) { if (existingRemaining !== null && existingRemaining !== undefined) { return Math.max(0, existingRemaining - expenseData.amount); } else if (existingBudget !== null && existingBudget !== undefined) { return Math.max(0, existingBudget - expenseData.amount); } } return existingRemaining !== null && existingRemaining !== undefined ? existingRemaining : (existingBudget !== null && existingBudget !== undefined ? existingBudget : null); } const newBudgetMatch = text.match(/(?:set|my)?\\s*(?:overall|total|monthly)?\\s*budget\\s*(?:to|is)?\\s*\\$?([0-9,]+)/i); if (newBudgetMatch && !text.includes('reduce') && !text.includes('cut') && !text.includes('lower') && !text.includes('decrease')) { const newBudget = parseFloat(newBudgetMatch[1].replace(/,/g, '')); return newBudget; } if (expenseData && expenseData.amount > 0) { if (existingRemaining !== null && existingRemaining !== undefined) { return Math.max(0, existingRemaining - expenseData.amount); } else if (existingBudget !== null && existingBudget !== undefined) { return Math.max(0, existingBudget - expenseData.amount); } } return existingRemaining !== null && existingRemaining !== undefined ? existingRemaining : (existingBudget !== null && existingBudget !== undefined ? existingBudget : null); })() }}",
              "type": "number"
            },
            {
              "id": "extract-profile-011",
              "name": "budget_context",
              "value": "={{ (() => { const profile = $('Merge User Context1').item.json.user_profile || {}; const budgets = profile.budget_limits || {}; const spending = profile.categories || {}; const context = { budgets, spending }; return context; })() }}",
              "type": "object"
            },
            {
              "id": "extract-profile-012",
              "name": "ai_savings_total",
              "value": "={{ (() => { const userText = $('Edit Fields1').item.json.user_text || ''; const aiOutput = $json.output || ''; const existing = $('Merge User Context1').item.json.user_profile?.ai_savings_total || 0; if (userText.toLowerCase().includes('reduce') || userText.toLowerCase().includes('set') || userText.toLowerCase().includes('change')) { return existing; } const text = aiOutput.toLowerCase(); if (!text || text.length < 10) { return existing; } const savingsMatch = text.match(/(?:save|saving|saved)\\s*\\$?([0-9,]+(?:\\.[0-9]{2})?)/i); if (savingsMatch) { const newSavings = parseFloat(savingsMatch[1].replace(/,/g, '')); if (newSavings > 0 && newSavings < 10000 && text.includes('month')) { return existing + newSavings; } } const cutMatch = text.match(/(?:cut|cutting)\\s+(?:dining|groceries|gas|entertainment|utilities|spending)\\s+to\\s+\\$?([0-9,]+)/i); if (cutMatch) { const targetAmount = parseFloat(cutMatch[1].replace(/,/g, '')); const currentMatch = text.match(/spent\\s+\\$?([0-9,]+)/i); if (currentMatch) { const currentAmount = parseFloat(currentMatch[1].replace(/,/g, '')); const savings = currentAmount - targetAmount; if (savings > 0 && savings < 10000) { return existing + savings; } } } return existing; })() }}",
              "type": "number"
            },
            {
              "id": "extract-profile-013",
              "name": "ai_savings_recommendations",
              "value": "={{ (() => { const userText = $('Edit Fields1').item.json.user_text || ''; const aiOutput = $json.output || ''; const existing = $('Merge User Context1').item.json.user_profile?.ai_savings_recommendations || []; if (userText.toLowerCase().includes('reduce') || userText.toLowerCase().includes('set') || userText.toLowerCase().includes('change')) { return existing; } const text = aiOutput; if (!text || text.length < 10) { return existing; } const recommendations = [...existing]; const savingsMatch = text.match(/(?:save|saving)\\s*\\$?([0-9,]+(?:\\.[0-9]{2})?)/i); if (savingsMatch) { const amount = parseFloat(savingsMatch[1].replace(/,/g, '')); if (amount > 0 && amount < 10000) { const date = new Date().toISOString().split('T')[0]; const categoryMatch = text.match(/(?:on|in|for|cut|cutting)\\s+(groceries|dining|gas|entertainment|utilities|other)/i); const category = categoryMatch ? categoryMatch[1].toLowerCase() : 'general'; recommendations.push({ date, category, amount, recommendation: text.slice(0, 150) }); } } return recommendations.slice(-10); })() }}",
              "type": "json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3664,
        112
      ],
      "id": "1a1d1fda-7079-4221-90cd-da23b936b8c3",
      "name": "Extract Profile Updates1"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-user-exists-001",
              "leftValue": "={{ $('Fetch User Profile1').item.json.user_id }}",
              "rightValue": "",
              "operator": {
                "type": "string",
                "operation": "exists",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3440,
        160
      ],
      "id": "23e7e604-40ae-4681-ad3a-4d40eca6eda7",
      "name": "Check if User Exists1"
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "user_profiles",
        "matchType": "allFilters",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "condition": "eq",
              "keyValue": "={{ $json.user_id }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "monthly_income",
              "fieldValue": "={{ $json.monthly_income }}"
            },
            {
              "fieldId": "categories",
              "fieldValue": "={{ $json.categories }}"
            },
            {
              "fieldId": "budget_limits",
              "fieldValue": "={{ $json.budget_limits }}"
            },
            {
              "fieldId": "spending_goals",
              "fieldValue": "={{ $json.spending_goals }}"
            },
            {
              "fieldId": "total_conversations",
              "fieldValue": "={{ $json.total_conversations }}"
            },
            {
              "fieldId": "last_updated",
              "fieldValue": "={{ $json.last_updated }}"
            },
            {
              "fieldId": "notes",
              "fieldValue": "={{ $json.notes }}"
            },
            {
              "fieldId": "total_budget",
              "fieldValue": "={{ $json.total_budget }}"
            },
            {
              "fieldId": "remaining_budget",
              "fieldValue": "={{ $json.remaining_budget }}"
            },
            {
              "fieldId": "ai_savings_total",
              "fieldValue": "={{ $json.ai_savings_total }}"
            },
            {
              "fieldId": "ai_savings_recommendations",
              "fieldValue": "={{ $json.ai_savings_recommendations }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3136,
        -16
      ],
      "id": "8f323769-6d96-48fd-b4fc-e84665a1946a",
      "name": "Update User Profile1",
      "credentials": {
        "supabaseApi": {
          "id": "4lrtFcWMFMluvyaj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "tableId": "user_profiles",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "user_id",
              "fieldValue": "={{ $json.user_id }}"
            },
            {
              "fieldId": "monthly_income",
              "fieldValue": "={{ $json.monthly_income }}"
            },
            {
              "fieldId": "categories",
              "fieldValue": "={{ $json.categories }}"
            },
            {
              "fieldId": "budget_limits",
              "fieldValue": "={{ $json.budget_limits }}"
            },
            {
              "fieldId": "spending_goals",
              "fieldValue": "={{ $json.spending_goals }}"
            },
            {
              "fieldId": "total_conversations",
              "fieldValue": "={{ $json.total_conversations }}"
            },
            {
              "fieldId": "last_updated",
              "fieldValue": "={{ $json.last_updated }}"
            },
            {
              "fieldId": "notes",
              "fieldValue": "={{ $json.notes }}"
            },
            {
              "fieldId": "total_budget",
              "fieldValue": "={{ $json.total_budget }}"
            },
            {
              "fieldId": "remaining_budget",
              "fieldValue": "={{ $json.remaining_budget }}"
            },
            {
              "fieldId": "ai_savings_total",
              "fieldValue": "={{ $json.ai_savings_total }}"
            },
            {
              "fieldId": "ai_savings_recommendations",
              "fieldValue": "={{ $json.ai_savings_recommendations }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -3136,
        272
      ],
      "id": "473c4b70-fcaa-45f5-9b0d-bc83620d8ab5",
      "name": "Create User Profile1",
      "credentials": {
        "supabaseApi": {
          "id": "4lrtFcWMFMluvyaj",
          "name": "Supabase account"
        }
      }
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a31a1f3e-2a90-4a4e-8f0a-6b0b2b4f2c01",
              "name": "runAnalyst",
              "value": "={{ (() => { const toBool = (v) => { if (typeof v === 'boolean') return v; if (typeof v === 'string') { const s = v.trim().toLowerCase(); if (['true','1','yes','y'].includes(s)) return true; if (['false','0','no','n'].includes(s)) return false; } if (typeof v === 'number') return v !== 0; return false; }; const getText = () => { const current = $json.user_text; if (typeof current === 'string' && current.trim().length) return current; const fromEdit = $('Edit Fields1').item.json.user_text; return typeof fromEdit === 'string' ? fromEdit : ''; }; const text = getText(); const t = text.toLowerCase(); const hints = ['price','prices','cheaper','cheap','cheapest','deal','deals','discount','discounts','coupon','coupons','promo','code','compare','comparison','student plan','student discount','bundle','bundles','where to buy','retailer','merchant','buy','purchase','cost','costs','renewal','subscription price','sale','sales','promo code','best deal','best price','cheapest place']; const hasPrice = hints.some(k => t.indexOf(k) !== -1); const plannerPrice = toBool($json.runPrice); const price = hasPrice || plannerPrice; return !price; })() }}",
              "type": "boolean"
            },
            {
              "id": "b52b8c2a-2c63-4f3a-94cc-0e56d7a7c1f2",
              "name": "runPrice",
              "value": "={{ (() => { const toBool = (v) => { if (typeof v === 'boolean') return v; if (typeof v === 'string') { const s = v.trim().toLowerCase(); if (['true','1','yes','y'].includes(s)) return true; if (['false','0','no','n'].includes(s)) return false; } if (typeof v === 'number') return v !== 0; return false; }; const getText = () => { const current = $json.user_text; if (typeof current === 'string' && current.trim().length) return current; const fromEdit = $('Edit Fields1').item.json.user_text; return typeof fromEdit === 'string' ? fromEdit : ''; }; const t = getText().toLowerCase(); const hints = ['price','prices','cheaper','cheap','cheapest','deal','deals','discount','discounts','coupon','coupons','promo','code','compare','comparison','student plan','student discount','bundle','bundles','where to buy','retailer','merchant','buy','purchase','cost','costs','renewal','subscription price','sale','sales','promo code','best deal','best price','cheapest place']; const hasPrice = hints.some(k => t.indexOf(k) !== -1); const plannerPrice = toBool($json.runPrice); return hasPrice || plannerPrice; })() }}",
              "type": "boolean"
            },
            {
              "id": "a28821b7-2b62-4cd2-8beb-b00b02d3d33d",
              "name": "user_text",
              "value": "={{ (() => { const current = $json.user_text; if (typeof current === 'string' && current.trim().length) return current; const fromEdit = $('Edit Fields1').item.json.user_text; return typeof fromEdit === 'string' ? fromEdit : ''; })() }}",
              "type": "string"
            },
            {
              "id": "da2b7fb9-7b0d-4a81-9f55-fb0e5d7145bb",
              "name": "price_queries",
              "value": "={{ (() => { const toBool = (v) => { if (typeof v === 'boolean') return v; if (typeof v === 'string') { const s = v.trim().toLowerCase(); if (['true','1','yes','y'].includes(s)) return true; if (['false','0','no','n'].includes(s)) return false; } if (typeof v === 'number') return v !== 0; return false; }; const getText = () => { const current = $json.user_text; if (typeof current === 'string' && current.trim().length) return current; const fromEdit = $('Edit Fields1').item.json.user_text; return typeof fromEdit === 'string' ? fromEdit : ''; }; const rawText = getText(); const textLower = rawText.toLowerCase(); const hints = ['price','prices','cheaper','cheap','cheapest','deal','deals','discount','discounts','coupon','coupons','promo','code','compare','comparison','student plan','student discount','bundle','bundles','where to buy','retailer','merchant','buy','purchase','cost','costs','renewal','subscription price','sale','sales','promo code','best deal','best price','cheapest place']; const hasPrice = hints.some(k => textLower.indexOf(k) !== -1); const plannerPrice = toBool($json.runPrice); const shouldPrice = hasPrice || plannerPrice; const existing = Array.isArray($json.price_queries) ? $json.price_queries.filter(q => typeof q === 'string' && q.trim().length) : []; if (!shouldPrice) { return []; } if (existing.length) { return existing.slice(0,3); } const stop = new Set(['find','me','please','you','help','need','want','would','like','look','looking','for','a','an','the','cheap','cheaper','cheapest','price','prices','cost','costs','deal','deals','discount','discounts','where','to','buy','get','in','near','around','waterloo','ontario','canada']); const tokens = rawText.split(/[^a-zA-Z0-9]+/).map(t => t.trim()).filter(Boolean); const filtered = tokens.filter(t => { const lower = t.toLowerCase(); if (stop.has(lower)) return false; return /^[a-z0-9]+$/i.test(t); }); const productTokens = filtered.map(t => t.replace(/^[\"'`]+|[\"'`]+$/g, '')); const product = productTokens.length ? productTokens.join(' ') : (rawText.trim() || 'grocery item'); const location = (() => { if (textLower.includes('kitchener')) return 'Kitchener Ontario'; if (textLower.includes('cambridge')) return 'Cambridge Ontario'; if (textLower.includes('toronto')) return 'Toronto Ontario'; if (textLower.includes('guelph')) return 'Guelph Ontario'; return 'Waterloo Ontario'; })(); const base = product.trim(); const queries = []; const seen = new Set(); const pushQuery = (q) => { const key = q.toLowerCase(); if (!seen.has(key) && q.trim()) { seen.add(key); queries.push(q.trim()); } }; pushQuery('best price ' + base + ' ' + location); pushQuery('cheap ' + base + ' deals ' + location); pushQuery(base + ' discount ' + location); if (!queries.length) { pushQuery(base + ' price ' + location); } return queries.slice(0,3); })() }}",
              "type": "json"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -6864,
        96
      ],
      "id": "2b8f5dfc-36b9-459a-8faf-ffdd271a5f14",
      "name": "Sub Agentic Task1"
    },
    {
      "parameters": {
        "model": "llama-3.3-70b-versatile",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [
        -5024,
        -160
      ],
      "id": "b7c75151-e7fe-4558-93b6-364b185cb71c",
      "name": "Groq Chat Model4",
      "credentials": {
        "groqApi": {
          "id": "AFEhhW2jthXCot4t",
          "name": "Groq account"
        }
      }
    },
    {
      "parameters": {
        "model": "openai/gpt-oss-120b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [
        -6432,
        480
      ],
      "id": "a75c6b6e-709e-49fa-97fd-5c64cf3fc68f",
      "name": "Groq Chat Model5",
      "credentials": {
        "groqApi": {
          "id": "AFEhhW2jthXCot4t",
          "name": "Groq account"
        }
      }
    },
    {
      "parameters": {
        "model": "openai/gpt-oss-120b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [
        -5072,
        512
      ],
      "id": "dc2923ce-4beb-4980-add2-39f4761056b0",
      "name": "Groq Chat Model6",
      "credentials": {
        "groqApi": {
          "id": "AFEhhW2jthXCot4t",
          "name": "Groq account"
        }
      }
    },
    {
      "parameters": {
        "model": "openai/gpt-oss-120b",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatGroq",
      "typeVersion": 1,
      "position": [
        -6528,
        1008
      ],
      "id": "dbf62510-45fe-4aa0-837b-582ee9fe1d8a",
      "name": "Groq Chat Model7",
      "credentials": {
        "groqApi": {
          "id": "AFEhhW2jthXCot4t",
          "name": "Groq account"
        }
      }
    },
    {
      "parameters": {
        "operation": "get",
        "tableId": "user_profiles",
        "filters": {
          "conditions": [
            {
              "keyName": "user_id",
              "keyValue": "={{ $('Edit Fields1').item.json.user_id }}"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -5824,
        912
      ],
      "id": "2c431672-aee4-4cfd-ba59-202aab17872f",
      "name": "Fetch User Data for Email",
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "4lrtFcWMFMluvyaj",
          "name": "Supabase account"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "format-email-content-001",
              "name": "email_subject",
              "value": "={{ `My Current Budget Summary (${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})` }}",
              "type": "string"
            },
            {
              "id": "format-email-content-002",
              "name": "email_body",
              "value": "={{ (() => { const profile = $json; const currentDate = new Date(); const monthName = currentDate.toLocaleDateString('en-US', { month: 'long', year: 'numeric' }); let content = `Hi,\\n\\nI wanted to share a quick overview of my current budget and recent spending:\\n\\n`; const totalBudget = profile.total_budget || 0; const remainingBudget = profile.remaining_budget !== null && profile.remaining_budget !== undefined ? profile.remaining_budget : totalBudget; if (totalBudget > 0) { content += `- Total monthly budget: $${totalBudget.toFixed(0)} (remaining: $${remainingBudget.toFixed(0)})\\n`; } if (profile.monthly_income) { content += `- Monthly income: $${profile.monthly_income}\\n`; } content += `\\nCategory Budgets\\n`; const budgets = profile.budget_limits || {}; const spending = profile.categories || {}; const categories = ['groceries', 'gas', 'dining', 'entertainment', 'utilities', 'other']; let hasBudgets = false; categories.forEach(cat => { const budget = budgets[cat]; const spent = spending[cat] || 0; if (budget) { hasBudgets = true; const remaining = Math.max(0, budget - spent); content += `- ${cat.charAt(0).toUpperCase() + cat.slice(1)}: $${budget} per month\\n`; } }); if (!hasBudgets) { content += `No category budgets set yet.\\n`; } content += `\\nSpending so far this month\\n`; let hasSpending = false; categories.forEach(cat => { const spent = spending[cat] || 0; const budget = budgets[cat]; if (spent > 0 || budget) { hasSpending = true; const remaining = budget ? Math.max(0, budget - spent) : null; content += `- ${cat.charAt(0).toUpperCase() + cat.slice(1)}: $${spent.toFixed(2)}`; if (remaining !== null) { content += ` (remaining: $${remaining.toFixed(2)})`; } content += `\\n`; } }); if (!hasSpending) { content += `No spending recorded yet this month.\\n`; } if (profile.notes) { const recentNotes = profile.notes.split('\\n').slice(-5); if (recentNotes.length > 0) { content += `\\nRecent receipts\\n`; recentNotes.forEach(note => { if (note.trim()) { const cleanNote = note.replace(/^\\[\\d{4}-\\d{2}-\\d{2}\\]\\s*/, ''); content += `- ${cleanNote}\\n`; } }); } } const totalSpent = Object.values(spending).reduce((sum, val) => sum + (val || 0), 0); if (totalBudget > 0 && totalSpent > 0) { const percentUsed = ((totalSpent / totalBudget) * 100).toFixed(1); content += `\\nOverall I'm staying `; if (remainingBudget > totalBudget * 0.3) { content += `well within my budget and have $${remainingBudget.toFixed(2)} left this month.`; } else if (remainingBudget > 0) { content += `close to my limit with $${remainingBudget.toFixed(2)} remaining this month.`; } else { content += `over budget this month.`; } content += `\\n`; } content += `\\n---\\n\\nThis email was sent automatically with n8n`; return content; })() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -5584,
        1056
      ],
      "id": "f70de80a-ac07-4a53-a5aa-cab7f63d4e7e",
      "name": "Format Email Content"
    },
    {
      "parameters": {
        "fromEmail": "noreply@budgetguardian.com",
        "toEmail": "={{ $('Edit Fields1').item.json.user_text }}",
        "subject": "={{ $json.email_subject }}",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -5408,
        928
      ],
      "id": "f1418ce7-f9b1-48c0-a459-36620c6ad5be",
      "name": "Send Data Email",
      "webhookId": "5edd6ac6-ef7f-46c8-b714-ec7ca38fd0d9",
      "credentials": {
        "smtp": {
          "id": "QAtcuERQ195x014G",
          "name": "SMTP account"
        }
      }
    },
    {
      "parameters": {
        "chatId": "={{ $('Telegram Message Trigger1').first().json.message.chat.id }}",
        "text": "âœ… I've sent your budget summary to {{ $('Edit Fields1').item.json.user_text }}!\n\nThe email includes:\nâ€¢ Your total monthly budget and remaining amount\nâ€¢ All category budgets and current spending\nâ€¢ Recent receipts and transactions\nâ€¢ Overall budget status\n\nIt's formatted as a ready-to-send email that you can forward or customize. Check your inbox (and spam folder if needed)! ðŸ“§",
        "additionalFields": {}
      },
      "type": "n8n-nodes-base.telegram",
      "typeVersion": 1.2,
      "position": [
        -5088,
        752
      ],
      "id": "9a952bb1-d270-40f4-a65b-b262636fd0be",
      "name": "Confirm Email Sent",
      "webhookId": "confirm-email-webhook-001",
      "credentials": {
        "telegramApi": {
          "id": "sl2XyaTKmEdfH4KK",
          "name": "Telegram account"
        }
      }
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        -6800,
        -704
      ],
      "id": "60e4bde6-5a7f-4351-a9ea-e3f2939ceeee",
      "name": "Transcribe audio1",
      "credentials": {
        "openAiApi": {
          "id": "n7FcR0fOh99ziM2b",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": false,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "check-should-email-001",
              "leftValue": "={{ $('Edit Fields1').item.json.user_text || '' }}",
              "rightValue": "/email",
              "operator": {
                "type": "string",
                "operation": "contains",
                "singleValue": true
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -3856,
        -80
      ],
      "id": "8def170d-9af6-493d-a5f0-4492eb5c9467",
      "name": "Check if Should Email Response"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "capture-message-001",
              "name": "message_content",
              "value": "={{ $('Compose Message - Direct1').item.json.output || $('Reply in Telegram (Direct)1').item.json.text || 'Your budget data will appear here.' }}",
              "type": "string"
            },
            {
              "id": "capture-email-001",
              "name": "user_email",
              "value": "={{ $('Edit Fields1').item.json.user_text.match(/[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}/)?.[0] || 'nourayman850@gmail.com' }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -3600,
        -240
      ],
      "id": "1ed543b8-d13e-4c4b-85cf-145730ab8587",
      "name": "Capture Email Data"
    },
    {
      "parameters": {
        "fromEmail": "noreply@budgetguardian.com",
        "toEmail": "={{ $json.user_email }}",
        "subject": "={{ `My Budget Summary (${new Date().toLocaleDateString('en-US', { month: 'long', year: 'numeric' })})` }}",
        "emailFormat": "text",
        "text": "={{ $json.message_content || 'Your budget data will appear here.' }}\n\n---\nThis email was sent automatically with n8n",
        "options": {}
      },
      "type": "n8n-nodes-base.emailSend",
      "typeVersion": 2.1,
      "position": [
        -3328,
        -144
      ],
      "id": "2719bcaa-90f9-4b02-a56b-739b6c0bbdf8",
      "name": "Send AI Response Email",
      "webhookId": "7a206559-3d19-4b5c-9e07-ef0adf3a40ac",
      "credentials": {
        "smtp": {
          "id": "QAtcuERQ195x014G",
          "name": "SMTP account"
        }
      }
    }
  ],
  "connections": {
    "Check if Image": {
      "main": [
        [
          {
            "node": "Get Image File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get Image File": {
      "main": [
        [
          {
            "node": "Analyze Receipt with Vision",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Analyze Receipt with Vision": {
      "main": [
        [
          {
            "node": "Format Expense Data",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Expense Data": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Telegram Message Trigger1": {
      "main": [
        [
          {
            "node": "Check if Audio file1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check if Image",
            "type": "main",
            "index": 0
          },
          {
            "node": "Check if Text",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Audio file1": {
      "main": [
        [
          {
            "node": "Get a file1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Get a file1": {
      "main": [
        [
          {
            "node": "Transcribe audio1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Text": {
      "main": [
        [
          {
            "node": "Set field1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Set field1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Edit Fields1": {
      "main": [
        [
          {
            "node": "Fetch User Profile1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if First Time User": {
      "main": [
        [
          {
            "node": "Send Welcome Message",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent - Planner1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Welcome Message": {
      "main": [
        [
          {
            "node": "AI Agent - Planner1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory (Planner)1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent - Planner1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Planner1": {
      "main": [
        [
          {
            "node": "Detect Budget Query1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If runAnalyst?1": {
      "main": [
        [
          {
            "node": "AI Agent - Analyst1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If runPrice?1": {
      "main": [
        [
          {
            "node": "AI Agent - Data Retrieval1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory (Analyst)1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent - Analyst1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Analyst1": {
      "main": [
        [
          {
            "node": "Compose Message - Analyst1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compose Message - Analyst1": {
      "main": [
        [
          {
            "node": "AI Agent - Direct Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Brave Search (Retrieval)1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Data Retrieval1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory (Retrieval)1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent - Data Retrieval1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser (Retrieval)1": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent - Data Retrieval1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Data Retrieval1": {
      "main": [
        [
          {
            "node": "Compose Message - Price1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compose Message - Price1": {
      "main": [
        [
          {
            "node": "AI Agent - Direct Response1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Fetch User Data for Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser1": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent - Planner1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser (Analyst)1": {
      "ai_outputParser": [
        [
          {
            "node": "AI Agent - Analyst1",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "Fetch User Profile1": {
      "main": [
        [
          {
            "node": "Merge User Context1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Merge User Context1": {
      "main": [
        [
          {
            "node": "Check if First Time User",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Simple Memory (Direct Response)1": {
      "ai_memory": [
        [
          {
            "node": "AI Agent - Direct Response1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Detect Budget Query1": {
      "main": [
        [
          {
            "node": "If Budget Query?1",
            "type": "main",
            "index": 0
          },
          {
            "node": "Sub Agentic Task1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "If Budget Query?1": {
      "main": [
        [
          {
            "node": "Compose Message - Budget1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Brave Search (Direct Response)1": {
      "ai_tool": [
        [
          {
            "node": "AI Agent - Direct Response1",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent - Direct Response1": {
      "main": [
        [
          {
            "node": "Compose Message - Direct1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Compose Message - Direct1": {
      "main": [
        [
          {
            "node": "Reply in Telegram (Direct)1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Reply in Telegram (Direct)1": {
      "main": [
        [
          {
            "node": "Check if Should Email Response",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract Profile Updates1": {
      "main": [
        [
          {
            "node": "Check if User Exists1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if User Exists1": {
      "main": [
        [
          {
            "node": "Update User Profile1",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Create User Profile1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Sub Agentic Task1": {
      "main": [
        [
          {
            "node": "If runAnalyst?1",
            "type": "main",
            "index": 0
          },
          {
            "node": "If runPrice?1",
            "type": "main",
            "index": 0
          },
          {
            "node": "AI Agent - Direct Response1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Groq Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Planner1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Groq Chat Model5": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Analyst1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Groq Chat Model6": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Direct Response1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Groq Chat Model7": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent - Data Retrieval1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Fetch User Data for Email": {
      "main": [
        [
          {
            "node": "Format Email Content",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Format Email Content": {
      "main": [
        [
          {
            "node": "Send Data Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Send Data Email": {
      "main": [
        [
          {
            "node": "Confirm Email Sent",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Transcribe audio1": {
      "main": [
        [
          {
            "node": "Edit Fields1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Check if Should Email Response": {
      "main": [
        [
          {
            "node": "Capture Email Data",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "Extract Profile Updates1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Capture Email Data": {
      "main": [
        [
          {
            "node": "Send AI Response Email",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "pinData": {},
  "meta": {
    "templateCredsSetupCompleted": true,
    "instanceId": "413509e3cb2730893b274ddf5c9e4497db5bb8d9e8033d511e51a211c7e12940"
  }
}